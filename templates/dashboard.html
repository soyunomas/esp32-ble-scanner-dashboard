<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Escaneos BLE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script> <!-- NUEVO para ejes de tiempo -->
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: #f4f7f6; 
            color: #333; 
            font-size:14px;
            display: flex; 
            min-height: 100vh; 
        }

        .sidebar {
            width: 260px; background-color: #2c3e50; color: #ecf0f1;
            padding: 20px 0 70px 0; 
            height: 100vh; position: fixed; left: 0; top: 0;
            overflow-y: auto; transition: transform 0.3s ease-in-out; z-index: 1000;
            display: flex; 
            flex-direction: column; 
        }
        .sidebar-header {
            padding: 0 20px 20px 20px; text-align: center;
            border-bottom: 1px solid #34495e; margin-bottom: 20px;
        }
        .sidebar-header h2 { margin: 0; color: #ecf0f1; font-size: 1.4em; }
        
        .sidebar-nav-container {
            flex-grow: 1; 
            overflow-y: auto; 
            padding-bottom: 10px; 
        }
        .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar nav ul li a {
            display: block; padding: 12px 20px; color: #ecf0f1; text-decoration: none;
            font-size: 0.95em; transition: background-color 0.2s ease; border-left: 3px solid transparent;
        }
        .sidebar nav ul li a:hover, .sidebar nav ul li a.active {
            background-color: #34495e; border-left-color: #3498db;
        }
        .sidebar nav ul li a .icon { margin-right: 10px; }

        .sidebar-refresh-control {
            padding: 10px 20px;
            background-color: #34495e; 
            border-top: 1px solid #4a6179; 
            text-align: center;
            box-sizing: border-box; 
            margin-top: auto; 
        }
        .sidebar-refresh-control button {
            padding: 6px 10px; 
            font-size: 0.8em; 
            color: #ecf0f1;
            background-color: #3498db;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 8px;
        }
        .sidebar-refresh-control button:hover {
            background-color: #2980b9;
        }
        .sidebar-refresh-control #refreshStatusSidebar { 
            font-size: 0.75em; 
            color: #bdc3c7;
        }


        .main-content-wrapper {
            flex-grow: 1; margin-left: 260px; padding: 20px;
            transition: margin-left 0.3s ease-in-out; overflow-y: auto;
        }
        .container { 
            max-width: 1300px; margin: 0 auto; background-color: #fff; 
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px 20px 20px;
        }
        
        .sidebar-toggle {
            display: none; position: fixed; top: 15px; left: 15px;
            background-color: #2c3e50; color: white; border: none;
            padding: 8px 12px; font-size: 1.5em; cursor: pointer; z-index: 1001; border-radius: 4px;
        }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content-wrapper { margin-left: 0; }
            .sidebar-toggle { display: block; }
        }

        h1 { display: none; } 
        h2 { font-size: 1.6em; margin-top: 20px; margin-bottom: 25px; text-align: left; padding-left: 5px; border-bottom: 2px solid #3498db; padding-bottom: 8px;} 
        h3 { font-size: 1.2em; margin-top: 15px; margin-bottom:10px; text-align: center;} 
        h4 { font-size: 1.1em; margin-top: 10px; margin-bottom:10px; text-align: left; color: #2980b9;}
        
        .analysis-controls button { 
            padding: 8px 15px; font-size: 0.9em; color: white;
            background-color: #3498db; border: none; border-radius: 4px;
            cursor: pointer; margin: 5px;
        }
        .analysis-controls button:hover { background-color: #2980b9; }


        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.85em; }
        th, td { border: 1px solid #e0e0e0; padding: 6px 8px; text-align: left; word-break: break-word; vertical-align: top; }
        th { background-color: #3498db; color: white; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .unique-devices-table tbody tr { cursor: pointer; }
        .unique-devices-table tbody tr:hover { background-color: #e6f7ff; }
        .action-icon { font-size: 1.2em; text-align: center; }
        
        .charts-container-stats-small {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .charts-container-fullwidth { 
            display: grid; grid-template-columns: 1fr;
            gap: 20px; margin-bottom: 30px;
        }
        .chart-box {
            padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px;
            background-color: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center;
        }
        .charts-container-stats-small .chart-box canvas {
            max-width: 100%;
            min-height: 220px;
            max-height: 320px;
        }
        .charts-container-fullwidth .chart-box canvas {
            max-width: 100%;
            min-height: 250px;
            max-height: 400px; /* Aumentado para gr√°ficos de tendencia */
        }

        #deviceHistorySection, #advancedAnalysisSection, #generalStatsSection, #uniqueDevicesSection {
             margin-top: 0px; 
             padding-top: 0px; 
             border-top: none; 
        }

        #deviceHistoryTableContainer { max-height: 550px; overflow-y: auto; }
        .no-data { text-align: center; color: #7f8c8d; padding: 20px; font-style: italic; }
        .loading-message { text-align: center; color: #3498db; padding: 15px; font-weight: bold; }
        .selected-row { background-color: #d1ecf1 !important; font-weight: bold; }
        
        td pre { 
            background-color: #f0f0f0; padding: 5px 8px; border-radius: 3px; 
            white-space: pre-wrap; word-break: break-all; max-height: 100px; overflow-y: auto;
            font-size:0.9em; margin: 0; border: 1px solid #ddd;
        }
        td ul { 
            background-color: #f0f0f0; padding: 8px 8px 8px 20px; border-radius: 3px; 
            max-height: 120px; overflow-y: auto;
            font-size:0.9em; margin: 0; list-style-type: disc; border: 1px solid #ddd;
        }
        td ul li { margin-bottom: 4px; }
        td ul li strong { color: #333; }
        td ul pre { font-size: 0.85em; padding: 2px 4px; display: inline-block; margin-left: 5px; max-height: 60px;}

        .analysis-controls {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            gap: 10px; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 6px;
        }
        .analysis-controls label { margin-right: 5px; font-weight: bold; font-size:0.9em; }
        .analysis-controls input[type="date"], .analysis-controls select {
            padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em;
        }
        .analysis-section { 
            margin-bottom: 30px; padding: 15px; border: 1px solid #e0e0e0; 
            border-radius: 6px; background-color: #fdfdfd;
        }


        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #2980b9; }
        th .sort-arrow { margin-left: 5px; opacity: 0.6; font-size: 0.8em; display: inline-block; width: 1em;}
        th .sort-arrow.active { opacity: 1; }

        .pagination-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin: 15px 0; padding: 10px; background-color: #f0f4f8;
            border-radius: 6px; flex-wrap: wrap;
        }
        .pagination-controls > div { margin: 5px; }
        .pagination-controls label { margin-right: 5px;}
        .pagination-controls select, .pagination-controls button {
            padding: 7px 12px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 0.9em; background-color: #fff;
        }
        .pagination-controls button { cursor: pointer; }
        .pagination-controls button:disabled {
            background-color: #e9ecef; cursor: not-allowed; opacity: 0.7;
        }
        .pagination-info { font-size: 0.9em; color: #555; }
        #loadingUniqueDevices { text-align: center; padding: 20px; font-style: italic; color: #3498db; }

        .content-section { display: none; }
        .content-section.active { display: block; }
    </style>
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><h2>BLE Dashboard</h2></div>
        <div class="sidebar-nav-container">
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-target="uniqueDevicesSection"><span class="icon">üìÑ</span> Dispositivos √önicos</a></li>
                    <li><a href="#" class="nav-link" data-target="generalStatsSection"><span class="icon">üìä</span> Estad√≠sticas Generales</a></li>
                    <li><a href="#" class="nav-link" data-target="deviceHistorySection" id="navDeviceHistoryLink" style="display:none;"><span class="icon">üìú</span> Historial Dispositivo</a></li>
                    <li><a href="#" class="nav-link" data-target="advancedAnalysisSection" id="navAdvancedAnalysisLink" style="display:none;"><span class="icon">üìà</span> An√°lisis Avanzado</a></li>
                </ul>
            </nav>
        </div>
        <div class="sidebar-refresh-control">
            <button id="toggleRefreshButtonSidebar">Pausar</button>
            <span id="refreshStatusSidebar">(Activado)</span>
            <hr style="border-color: #4a6179; margin-top:8px; margin-bottom: 5px;">
        </div>
    </aside>

    <div class="main-content-wrapper" id="mainContentWrapper">
        <div class="container">
            
            <section id="uniqueDevicesSection" class="content-section active">
                <h2>Dispositivos BLE √önicos Detectados</h2>
                <div class="pagination-controls">
                    <div>
                        <label for="pageSizeSelect">Mostrar:</label>
                        <select id="pageSizeSelect">
                            <option value="20" selected>20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option>
                            <option value="60">60</option><option value="70">70</option><option value="80">80</option><option value="90">90</option><option value="100">100</option>
                        </select>
                        <span class="pagination-info" id="paginationInfo">Cargando...</span>
                    </div>
                    <div>
                        <button id="prevPageButton" disabled>Anterior</button>
                        <button id="nextPageButton" disabled>Siguiente</button>
                    </div>
                </div>
                <div id="uniqueDevicesTableContainer">
                    <p id="loadingUniqueDevices" class="loading-message" style="display: none;">Cargando dispositivos...</p>
                    <table class="unique-devices-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort_by="last_seen_timestamp">√öltima Detecci√≥n <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort_by="ble_mac_address">BLE MAC Address <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort_by="best_ble_device_name">BLE Device Name <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort_by="manufacturer_name">Fabricante <span class="sort-arrow"></span></th>
                                <th class="sortable" data-sort_by="adv_packets_count">Adv Packets <span class="sort-arrow"></span></th>
                                <th style="text-align:center;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="uniqueDevicesTbody"></tbody>
                    </table>
                    <p id="noUniqueDevicesData" class="no-data" style="display: none;">No se han detectado dispositivos BLE √∫nicos todav√≠a.</p>
                </div>
            </section>

            <section id="generalStatsSection" class="content-section">
                <h2>Estad√≠sticas Generales</h2>
                <div class="analysis-section">
                    <h4>Horas de Mayor Actividad (Dispositivos √önicos Global)</h4>
                    <div class="analysis-controls">
                        <label for="peakStatsStartDate">Desde:</label><input type="date" id="peakStatsStartDate" required>
                        <label for="peakStatsEndDate">Hasta:</label><input type="date" id="peakStatsEndDate" required>
                        <button id="analyzePeakStatsButton">Analizar Horas Pico</button>
                    </div>
                    <p id="peakActivityStatsLoading" class="loading-message" style="display: none;">Cargando an√°lisis...</p>
                    <p id="noPeakActivityStatsData" class="no-data" style="display: none;">No hay datos para el rango.</p>
                    <div class="charts-container-fullwidth">
                        <div class="chart-box" id="peakActivityStatsChartContainer">
                            <canvas id="peakActivityStatsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="charts-container-stats-small">
                    <div class="chart-box">
                        <h3>Dispositivos √önicos por ESP</h3>
                        <canvas id="espDeviceChart"></canvas>
                        <p class="no-data" id="noEspData" style="display:none;">N/A</p>
                    </div>
                    <div class="chart-box">
                        <h3>Distribuci√≥n RSSI (Global)</h3>
                        <canvas id="rssiDistributionChart"></canvas>
                        <p class="no-data" id="noRssiData" style="display:none;">N/A</p>
                    </div>
                    <div class="chart-box">
                        <h3>An√°lisis de Fabricantes (Top 7)</h3>
                        <canvas id="manufacturerAnalysisChart"></canvas>
                        <p class="no-data" id="noManufacturerData" style="display:none;">Cargando datos o N/A</p>
                    </div>
                </div>
            </section>
            
            <section id="deviceHistorySection" class="content-section">
                <h2>Historial Dispositivo</h2>
                <h3>Historial para <span id="selectedMacForHistory"></span> (√öltimos 20 registros)</h3>
                <div id="deviceHistoryTableContainer">
                    <p id="historyLoading" class="loading-message" style="display: none;">Cargando historial...</p>
                    <table id="deviceHistoryTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Timestamp</th><th>ESP ID</th><th>Name</th><th>RSSI</th><th>TX Pwr</th><th>Appear.</th>
                                <th>Fabricante (ID)</th><th>Manuf. Data</th><th>Service UUIDs</th><th>Service Data</th>
                            </tr>
                        </thead>
                        <tbody id="deviceHistoryTbody"></tbody>
                    </table>
                    <p id="noHistoryData" class="no-data" style="display: none;">No hay historial para este dispositivo.</p>
                </div>
            </section>

            <section id="advancedAnalysisSection" class="content-section">
                <h2>An√°lisis Avanzado</h2>
                <h3>An√°lisis para <span id="selectedMacForAdvancedAnalysis" style="color: #3498db;">N/A</span></h3>
                
                <div class="analysis-section">
                    <h4>Actividad Diaria Detallada (Detecciones)</h4>
                    <div class="analysis-controls">
                        <label for="detailStartDate">Desde:</label><input type="date" id="detailStartDate" required>
                        <label for="detailEndDate">Hasta:</label><input type="date" id="detailEndDate" required>
                        <button id="analyzeDetailButton">Analizar Actividad Detallada</button>
                    </div>
                    <p id="deviceDetailActivityLoading" class="loading-message" style="display: none;">Cargando an√°lisis detallado...</p>
                    <p id="noDeviceDetailActivityData" class="no-data" style="display: none;">No hay datos para los filtros seleccionados.</p>
                    <div class="charts-container-fullwidth"><div class="chart-box" id="deviceDetailActivityChartContainer" style="display:none;"><canvas id="deviceDetailActivityChart"></canvas></div></div>
                </div>

                <div class="analysis-section">
                    <h4>Frecuencia de Aparici√≥n Agregada (Detecciones)</h4>
                    <div class="analysis-controls">
                        <label for="granularity">Granularidad:</label>
                        <select id="granularity">
                            <option value="hourly">Por Hora del D√≠a</option><option value="daily_week">Por D√≠a de la Semana</option>
                            <option value="weekly">Semanal</option><option value="monthly">Mensual</option>
                        </select>
                        <label for="freqStartDate">Desde:</label><input type="date" id="freqStartDate">
                        <label for="freqEndDate">Hasta:</label><input type="date" id="freqEndDate">
                        <button id="analyzeFrequencyButton">Analizar Frecuencia Agregada</button>
                    </div>
                    <p id="deviceAggregatedActivityLoading" class="loading-message" style="display: none;">Cargando an√°lisis agregado...</p>
                    <p id="noDeviceAggregatedActivityData" class="no-data" style="display: none;">No hay datos para los filtros.</p>
                    <div class="charts-container-fullwidth"><div class="chart-box" id="deviceAggregatedActivityChartContainer" style="display:none;"><canvas id="deviceAggregatedActivityChart"></canvas></div></div>
                </div>

                <!-- NUEVA SECCI√ìN: An√°lisis de Intensidad de Se√±al (RSSI) -->
                <div class="analysis-section">
                    <h4>An√°lisis de Intensidad de Se√±al (RSSI)</h4>
                    
                    <!-- Sub-secci√≥n: Tendencia RSSI por Dispositivo -->
                    <div style="margin-bottom: 25px; padding-bottom:15px; border-bottom: 1px dashed #ccc;">
                        <h5>Tendencia RSSI para Dispositivo: <span id="selectedMacForRssiTrend" style="color: #16a085;">(Seleccione MAC)</span></h5>
                        <div class="analysis-controls">
                            <label for="rssiTrendStartDate">Desde:</label><input type="date" id="rssiTrendStartDate">
                            <label for="rssiTrendEndDate">Hasta:</label><input type="date" id="rssiTrendEndDate">
                            <label for="espSelectForDeviceRssiTrend">ESP ID:</label>
                            <select id="espSelectForDeviceRssiTrend">
                                <option value="">Todos los ESPs</option>
                                <!-- Opciones se llenar√°n din√°micamente -->
                            </select>
                            <button id="analyzeDeviceRssiTrendButton" disabled>Analizar Tendencia RSSI</button>
                        </div>
                        <p id="deviceRssiTrendLoading" class="loading-message" style="display: none;">Cargando tendencia RSSI...</p>
                        <p id="noDeviceRssiTrendData" class="no-data" style="display: none;">No hay datos de RSSI para los filtros.</p>
                        <div class="charts-container-fullwidth">
                            <div class="chart-box" id="deviceRssiTrendChartContainer" style="display:none;">
                                <canvas id="deviceRssiTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-secci√≥n: Distribuci√≥n RSSI por ESP -->
                    <div>
                        <h5>Distribuci√≥n RSSI por ESP</h5>
                        <div class="analysis-controls">
                             <label for="espSelectForEspRssiDistribution">ESP ID:</label>
                             <select id="espSelectForEspRssiDistribution">
                                 <option value="">Seleccione un ESP</option>
                                 <!-- Opciones se llenar√°n din√°micamente -->
                             </select>
                            <label for="rssiDistStartDate">Desde:</label><input type="date" id="rssiDistStartDate">
                            <label for="rssiDistEndDate">Hasta:</label><input type="date" id="rssiDistEndDate">
                            <button id="analyzeEspRssiDistributionButton" disabled>Analizar Distribuci√≥n RSSI de ESP</button>
                        </div>
                        <p id="espRssiDistributionLoading" class="loading-message" style="display: none;">Cargando distribuci√≥n RSSI del ESP...</p>
                        <p id="noEspRssiDistributionData" class="no-data" style="display: none;">No hay datos para este ESP y filtros.</p>
                        <div class="charts-container-fullwidth">
                            <div class="chart-box" id="espRssiDistributionChartAdvancedContainer" style="display:none;">
                                <canvas id="espRssiDistributionChartAdvanced"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
        </div> 
    </div> 

    <script>
        // Helper para escapar HTML, sin cambios
        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return 'N/A';
                return String(unsafe)
                     .replace(/&/g, "&amp;") // Corregido: &amp; en lugar de solo &
                     .replace(/</g, "&lt;")  // Corregido: &lt; en lugar de solo <
                     .replace(/>/g, "&gt;")  // Corregido: &gt; en lugar de solo >
                     .replace(/"/g, "&quot;") // Corregido: &quot; en lugar de solo "
                     .replace(/'/g, "&#039;"); // Corregido: &#039; en lugar de solo '
        }

        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            const navDeviceHistoryLink = document.getElementById('navDeviceHistoryLink');
            const navAdvancedAnalysisLink = document.getElementById('navAdvancedAnalysisLink');

            const uniqueDevicesTbody = document.getElementById('uniqueDevicesTbody');
            const loadingUniqueDevicesMsg = document.getElementById('loadingUniqueDevices');
            const noUniqueDevicesDataMsg = document.getElementById('noUniqueDevicesData');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const prevPageButton = document.getElementById('prevPageButton');
            const nextPageButton = document.getElementById('nextPageButton');
            const paginationInfoSpan = document.getElementById('paginationInfo');
            const sortableHeaders = document.querySelectorAll('.unique-devices-table th.sortable');
            
            const historyTableBody = document.getElementById('deviceHistoryTbody');
            const selectedMacSpanForHistory = document.getElementById('selectedMacForHistory');
            const historyLoadingMsg = document.getElementById('historyLoading');
            const historyTableElement = document.getElementById('deviceHistoryTable');
            const noHistoryDataMsg = document.getElementById('noHistoryData');
            
            const REFRESH_INTERVAL_MS = 30000;
            let autoRefreshEnabled = true;
            let refreshIntervalId = null;
            const toggleRefreshButtonSidebar = document.getElementById('toggleRefreshButtonSidebar');
            const refreshStatusSpanSidebar = document.getElementById('refreshStatusSidebar');

            const selectedMacSpanForAdvancedAnalysis = document.getElementById('selectedMacForAdvancedAnalysis');
            let currentSelectedMacForAnalysis = null;

            // Controles Actividad Diaria Detallada
            const detailStartDateInput = document.getElementById('detailStartDate');
            const detailEndDateInput = document.getElementById('detailEndDate');
            const analyzeDetailButton = document.getElementById('analyzeDetailButton');
            const deviceDetailActivityLoadingMsg = document.getElementById('deviceDetailActivityLoading');
            const noDeviceDetailActivityDataMsgElem = document.getElementById('noDeviceDetailActivityData');
            const deviceDetailActivityChartContainer = document.getElementById('deviceDetailActivityChartContainer');
            const deviceDetailActivityChartCanvas = document.getElementById('deviceDetailActivityChart').getContext('2d');
            let deviceDetailActivityChartInstance = null;

            // Controles Frecuencia Agregada
            const granularitySelect = document.getElementById('granularity');
            const freqStartDateInput = document.getElementById('freqStartDate');
            const freqEndDateInput = document.getElementById('freqEndDate');
            const analyzeFrequencyButton = document.getElementById('analyzeFrequencyButton');
            const deviceAggregatedActivityLoadingMsg = document.getElementById('deviceAggregatedActivityLoading');
            const noDeviceAggregatedActivityDataMsgElem = document.getElementById('noDeviceAggregatedActivityData');
            const deviceAggregatedActivityChartContainer = document.getElementById('deviceAggregatedActivityChartContainer');
            const deviceAggregatedActivityChartCanvas = document.getElementById('deviceAggregatedActivityChart').getContext('2d');
            let deviceAggregatedActivityChartInstance = null;

            // Controles Estad√≠sticas Generales - Horas Pico
            const peakStatsStartDateInput = document.getElementById('peakStatsStartDate');
            const peakStatsEndDateInput = document.getElementById('peakStatsEndDate');
            const analyzePeakStatsButton = document.getElementById('analyzePeakStatsButton');
            const peakActivityStatsLoadingMsg = document.getElementById('peakActivityStatsLoading');
            const noPeakActivityStatsDataMsgElem = document.getElementById('noPeakActivityStatsData');
            // const peakActivityStatsChartContainer = document.getElementById('peakActivityStatsChartContainer'); // Ya definido
            const peakActivityStatsChartCanvas = document.getElementById('peakActivityStatsChart').getContext('2d');
            let peakActivityStatsChartInstance = null;
            
            // Controles Estad√≠sticas Generales - Fabricantes
            const manufacturerAnalysisChartCanvas = document.getElementById('manufacturerAnalysisChart').getContext('2d');
            const noManufacturerDataMsg = document.getElementById('noManufacturerData');
            let manufacturerAnalysisChartInstance = null;

            // NUEVO: Controles para An√°lisis RSSI
            const selectedMacForRssiTrendSpan = document.getElementById('selectedMacForRssiTrend');
            const rssiTrendStartDateInput = document.getElementById('rssiTrendStartDate');
            const rssiTrendEndDateInput = document.getElementById('rssiTrendEndDate');
            const espSelectForDeviceRssiTrend = document.getElementById('espSelectForDeviceRssiTrend');
            const analyzeDeviceRssiTrendButton = document.getElementById('analyzeDeviceRssiTrendButton');
            const deviceRssiTrendLoadingMsg = document.getElementById('deviceRssiTrendLoading');
            const noDeviceRssiTrendDataMsg = document.getElementById('noDeviceRssiTrendData');
            const deviceRssiTrendChartContainer = document.getElementById('deviceRssiTrendChartContainer');
            const deviceRssiTrendChartCanvas = document.getElementById('deviceRssiTrendChart').getContext('2d');
            let deviceRssiTrendChartInstance = null;

            const espSelectForEspRssiDistribution = document.getElementById('espSelectForEspRssiDistribution');
            const rssiDistStartDateInput = document.getElementById('rssiDistStartDate');
            const rssiDistEndDateInput = document.getElementById('rssiDistEndDate');
            const analyzeEspRssiDistributionButton = document.getElementById('analyzeEspRssiDistributionButton');
            const espRssiDistributionLoadingMsg = document.getElementById('espRssiDistributionLoading');
            const noEspRssiDistributionDataMsg = document.getElementById('noEspRssiDistributionData');
            const espRssiDistributionChartAdvancedContainer = document.getElementById('espRssiDistributionChartAdvancedContainer');
            const espRssiDistributionChartAdvancedCanvas = document.getElementById('espRssiDistributionChartAdvanced').getContext('2d');
            let espRssiDistributionAdvancedChartInstance = null;


            let currentSelectedRow = null;
            let currentUniqueDevicesPage = 1;
            let uniqueDevicesPageSize = parseInt(pageSizeSelect.value, 10);
            let uniqueDevicesSortBy = 'last_seen_timestamp';
            let uniqueDevicesSortOrder = 'desc';
            let uniqueDevicesTotalPages = 0;
            let uniqueDevicesTotalDevices = 0;

            const chartColors = [ // Colores para gr√°ficos multi-l√≠nea
                'rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)',
                'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
                'rgba(0, 102, 204, 1)', 'rgba(204, 0, 0, 1)', 'rgba(0, 153, 76, 1)',
                'rgba(255, 128, 0, 1)' 
            ];


            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('active'));

            function getFormattedDate(date) { 
                return date.toISOString().split('T')[0];
            }

            function getMonthDateRange(date = new Date()) {
                const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                return {
                    start: getFormattedDate(firstDay),
                    end: getFormattedDate(lastDay)
                };
            }
            
            function setDefaultDatesForInputs(startDateInput, endDateInput) {
                const range = getMonthDateRange();
                startDateInput.value = range.start;
                endDateInput.value = range.end;
            }

            function setDefaultDatesForPeakStats() { 
                setDefaultDatesForInputs(peakStatsStartDateInput, peakStatsEndDateInput);
            }

            function showSection(targetId) {
                contentSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetId) section.classList.add('active');
                });
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.target === targetId) link.classList.add('active');
                });
                if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }

                if (targetId === 'generalStatsSection') {
                    setDefaultDatesForPeakStats(); 
                    fetchAndRenderPeakActivityStats(); 
                    fetchAndRenderManufacturerAnalysis();
                }
                if ((targetId === 'deviceHistorySection' || targetId === 'advancedAnalysisSection') && !currentSelectedMacForAnalysis) {
                    showSection('uniqueDevicesSection'); 
                    navDeviceHistoryLink.style.display = 'none';
                    navAdvancedAnalysisLink.style.display = 'none';
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    showSection(targetId);
                });
            });


            function updateSortArrows() {  
                sortableHeaders.forEach(header => {
                    const arrowSpan = header.querySelector('.sort-arrow');
                    if (header.dataset.sort_by === uniqueDevicesSortBy) {
                        arrowSpan.innerHTML = uniqueDevicesSortOrder === 'asc' ? '‚ñ≤' : '‚ñº';
                        arrowSpan.classList.add('active');
                    } else {
                        arrowSpan.innerHTML = ''; arrowSpan.classList.remove('active');
                    }
                });
            }
            function fetchAndRenderUniqueDevices() { 
                loadingUniqueDevicesMsg.style.display = 'block';
                noUniqueDevicesDataMsg.style.display = 'none';
                uniqueDevicesTbody.innerHTML = '';
                prevPageButton.disabled = true;
                nextPageButton.disabled = true;

                const url = `/api/unique-devices?page=${currentUniqueDevicesPage}&page_size=${uniqueDevicesPageSize}&sort_by=${uniqueDevicesSortBy}&sort_order=${uniqueDevicesSortOrder}`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                           return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        loadingUniqueDevicesMsg.style.display = 'none';
                        uniqueDevicesTotalDevices = data.total_devices;
                        uniqueDevicesTotalPages = data.total_pages;
                        currentUniqueDevicesPage = data.current_page;
                        uniqueDevicesSortBy = data.sort_by;
                        uniqueDevicesSortOrder = data.sort_order;

                        if (data.devices && data.devices.length > 0) {
                            data.devices.forEach(device => {
                                const tr = document.createElement('tr');
                                tr.dataset.mac = device.ble_mac_address;
                                tr.innerHTML = `
                                    <td>${escapeHtml(device.last_seen_timestamp)}</td>
                                    <td>${escapeHtml(device.ble_mac_address)}</td>
                                    <td>${escapeHtml(device.best_ble_device_name)}</td>
                                    <td>${escapeHtml(device.manufacturer_name)}</td>
                                    <td>${escapeHtml(device.adv_packets_count)}</td>
                                    <td class="action-icon">üîç</td>
                                `;
                                uniqueDevicesTbody.appendChild(tr);
                            });
                            addEventListenersToDeviceRows();
                        } else {
                            noUniqueDevicesDataMsg.style.display = 'block';
                        }
                        updatePaginationControls();
                        updateSortArrows();
                    })
                    .catch(error => {
                        loadingUniqueDevicesMsg.style.display = 'none';
                        uniqueDevicesTbody.innerHTML = `<tr><td colspan="6" class="no-data">Error cargando dispositivos: ${escapeHtml(error.message)}</td></tr>`;
                        console.error('Error fetching unique devices:', error);
                        updatePaginationControls();
                        updateSortArrows();
                    });
            }
            function updatePaginationControls() { 
                 if (uniqueDevicesTotalDevices === 0) {
                    paginationInfoSpan.textContent = "No hay dispositivos.";
                    prevPageButton.disabled = true;
                    nextPageButton.disabled = true;
                } else {
                    paginationInfoSpan.textContent = `P√°gina ${currentUniqueDevicesPage} de ${uniqueDevicesTotalPages} (${uniqueDevicesTotalDevices} dispositivos)`;
                    prevPageButton.disabled = currentUniqueDevicesPage <= 1;
                    nextPageButton.disabled = currentUniqueDevicesPage >= uniqueDevicesTotalPages;
                }
            }
            pageSizeSelect.addEventListener('change', function() { 
                uniqueDevicesPageSize = parseInt(this.value, 10);
                currentUniqueDevicesPage = 1;
                fetchAndRenderUniqueDevices();
            });
            prevPageButton.addEventListener('click', function() {
                if (currentUniqueDevicesPage > 1) {
                    currentUniqueDevicesPage--;
                    fetchAndRenderUniqueDevices();
                }
            });
            nextPageButton.addEventListener('click', function() {
                if (currentUniqueDevicesPage < uniqueDevicesTotalPages) {
                    currentUniqueDevicesPage++;
                    fetchAndRenderUniqueDevices();
                }
            });
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const newSortBy = this.dataset.sort_by;
                    if (uniqueDevicesSortBy === newSortBy) {
                        uniqueDevicesSortOrder = uniqueDevicesSortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        uniqueDevicesSortBy = newSortBy;
                        uniqueDevicesSortOrder = 'desc';
                    }
                    currentUniqueDevicesPage = 1;
                    fetchAndRenderUniqueDevices();
                });
            });
            
            function startAutoRefresh() {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
                refreshIntervalId = setInterval(() => {
                    const uniqueDevicesSectionActive = document.getElementById('uniqueDevicesSection').classList.contains('active');
                    if (autoRefreshEnabled && uniqueDevicesSectionActive) {
                        fetchAndRenderUniqueDevices();
                    }
                    const generalStatsSectionActive = document.getElementById('generalStatsSection').classList.contains('active');
                    if (autoRefreshEnabled && generalStatsSectionActive) {
                        fetchAndRenderPeakActivityStats(); 
                        fetchAndRenderManufacturerAnalysis();
                    }
                }, REFRESH_INTERVAL_MS);
                refreshStatusSpanSidebar.textContent = `(Activado)`;
                toggleRefreshButtonSidebar.textContent = 'Pausar';
                autoRefreshEnabled = true; 
            }
            function stopAutoRefresh() {
                 if (refreshIntervalId) {
                    clearInterval(refreshIntervalId);
                    refreshIntervalId = null;
                }
                refreshStatusSpanSidebar.textContent = '(Pausado)';
                toggleRefreshButtonSidebar.textContent = 'Reanudar';
                autoRefreshEnabled = false;
            }
            toggleRefreshButtonSidebar.addEventListener('click', () => {
                 if (autoRefreshEnabled) stopAutoRefresh();
                else startAutoRefresh();
            });
            
            function formatServiceUUIDsForDisplay(serviceUUIDsResolved) {
                if (!serviceUUIDsResolved || serviceUUIDsResolved.length === 0) return 'N/A';
                let html = '<ul>';
                serviceUUIDsResolved.forEach(item => {
                    html += `<li><strong>${escapeHtml(item.name)}:</strong> ${escapeHtml(item.uuid)}</li>`;
                });
                html += '</ul>';
                return html;
            }
            function formatServiceDataForDisplay(serviceDataResolved) {
                if (!serviceDataResolved || Object.keys(serviceDataResolved).length === 0) return 'N/A';
                if (serviceDataResolved.error) return `<pre>${escapeHtml(serviceDataResolved.error)}</pre>`;
                let html = '<ul>';
                for (const key in serviceDataResolved) { 
                    let valueStr = serviceDataResolved[key];
                    if (typeof valueStr === 'object') {
                        valueStr = JSON.stringify(valueStr, null, 2);
                    }
                    html += `<li><strong>${escapeHtml(key)}:</strong> <pre>${escapeHtml(valueStr)}</pre></li>`;
                }
                html += '</ul>';
                return html;
            }
            function addEventListenersToDeviceRows() {
                const deviceRows = uniqueDevicesTbody.querySelectorAll('tr');
                deviceRows.forEach(row => {
                    row.removeEventListener('click', handleDeviceRowClick); 
                    row.addEventListener('click', handleDeviceRowClick);
                });
            }

            function handleDeviceRowClick() { 
                const macAddress = this.dataset.mac;
                if (currentSelectedRow) currentSelectedRow.classList.remove('selected-row');
                this.classList.add('selected-row');
                currentSelectedRow = this;

                currentSelectedMacForAnalysis = macAddress; 

                navDeviceHistoryLink.style.display = 'block';
                navAdvancedAnalysisLink.style.display = 'block';
                
                selectedMacSpanForHistory.textContent = escapeHtml(macAddress); 
                selectedMacSpanForAdvancedAnalysis.textContent = escapeHtml(macAddress);
                selectedMacForRssiTrendSpan.textContent = escapeHtml(macAddress); // NUEVO para RSSI Trend
                analyzeDeviceRssiTrendButton.disabled = false; // Habilitar bot√≥n de RSSI Trend
                
                historyTableElement.style.display = 'none';
                noHistoryDataMsg.style.display = 'none';
                historyLoadingMsg.style.display = 'block';
                historyTableBody.innerHTML = ''; 

                fetch(`/api/device-history/${macAddress}`)
                    .then(response => { 
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        historyLoadingMsg.style.display = 'none';
                        if (data && data.length > 0) {
                            data.forEach(log => { 
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${escapeHtml(log.formatted_timestamp)}</td><td>${escapeHtml(log.esp_device_id)}</td>
                                    <td>${escapeHtml(log.ble_device_name)}</td><td>${log.ble_rssi !== null ? escapeHtml(log.ble_rssi) : 'N/A'}</td>
                                    <td>${log.tx_power !== null ? escapeHtml(log.tx_power) : 'N/A'}</td><td>${log.appearance !== null ? escapeHtml(log.appearance) : 'N/A'}</td>
                                    <td>${escapeHtml(log.manufacturer_company)} (${escapeHtml(log.manufacturer_company_id)})</td>
                                    <td><pre>${escapeHtml(log.manufacturer_specific_data)}</pre></td>
                                    <td>${formatServiceUUIDsForDisplay(log.service_uuids_resolved)}</td>
                                    <td>${formatServiceDataForDisplay(log.service_data_resolved)}</td>
                                `;
                                historyTableBody.appendChild(tr);
                            });
                            historyTableElement.style.display = 'table';
                        } else {
                            noHistoryDataMsg.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        historyLoadingMsg.style.display = 'none';
                        noHistoryDataMsg.textContent = `Error cargando historial: ${escapeHtml(error.message)}.`;
                        noHistoryDataMsg.style.display = 'block';
                    });

                // Limpiar gr√°ficos de an√°lisis avanzado anteriores
                if (deviceDetailActivityChartInstance) deviceDetailActivityChartInstance.destroy();
                deviceDetailActivityChartContainer.style.display = 'none';
                noDeviceDetailActivityDataMsgElem.style.display = 'none'; 
                
                if (deviceAggregatedActivityChartInstance) deviceAggregatedActivityChartInstance.destroy();
                deviceAggregatedActivityChartContainer.style.display = 'none';
                noDeviceAggregatedActivityDataMsgElem.style.display = 'none'; 

                if (deviceRssiTrendChartInstance) deviceRssiTrendChartInstance.destroy(); // NUEVO
                deviceRssiTrendChartContainer.style.display = 'none'; // NUEVO
                noDeviceRssiTrendDataMsg.style.display = 'none'; // NUEVO

                // MODIFICACI√ìN 1 & 2: Establecer fechas y activar an√°lisis
                setDefaultDatesForInputs(detailStartDateInput, detailEndDateInput);
                analyzeDetailButton.click(); // Simular clic para activar an√°lisis

                setDefaultDatesForInputs(freqStartDateInput, freqEndDateInput);
                // analyzeFrequencyButton.click(); // Se podr√≠a activar, o dejar que el usuario elija granularidad primero

                // NUEVO: Poblar selectores de ESP para el dispositivo actual y establecer fechas para RSSI trend
                fetchAndPopulateEspSelectorForDeviceRssiTrend(macAddress);
                setDefaultDatesForInputs(rssiTrendStartDateInput, rssiTrendEndDateInput);
                // analyzeDeviceRssiTrendButton.click(); // Opcional: activar autom√°ticamente
            }
            
            // An√°lisis de Actividad Diaria Detallada
            analyzeDetailButton.addEventListener('click', function() { 
                if (!currentSelectedMacForAnalysis) {
                    alert("Por favor, seleccione un dispositivo de la tabla primero."); return;
                }
                const startDate = detailStartDateInput.value;
                const endDate = detailEndDateInput.value;
                if (!startDate || !endDate) {
                    alert("Por favor, seleccione un rango de fechas para el an√°lisis detallado."); return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                     alert("La fecha 'Desde' no puede ser posterior a la fecha 'Hasta'."); return;
                }

                let apiUrl = `/api/device-activity/${currentSelectedMacForAnalysis}?granularity=daily_date&startDate=${startDate}&endDate=${endDate}`;

                deviceDetailActivityLoadingMsg.style.display = 'block';
                noDeviceDetailActivityDataMsgElem.style.display = 'none';
                deviceDetailActivityChartContainer.style.display = 'none';
                if (deviceDetailActivityChartInstance) deviceDetailActivityChartInstance.destroy();

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`) });
                        return response.json();
                    })
                    .then(data => {
                        deviceDetailActivityLoadingMsg.style.display = 'none';
                        if (data.labels && data.labels.length > 0 && data.data.some(d => d > 0)) { // Asegurarse que hay datos > 0 
                            deviceDetailActivityChartContainer.style.display = 'block';
                            deviceDetailActivityChartInstance = new Chart(deviceDetailActivityChartCanvas, { 
                                type: 'bar',
                                data: {
                                    labels: data.labels,
                                    datasets: [{
                                        label: `Detecciones diarias para ${escapeHtml(currentSelectedMacForAnalysis)}`,
                                        data: data.data,
                                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                                        borderColor: 'rgba(153, 102, 255, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    scales: { 
                                        x: { type: 'time', time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd', displayFormats: {'day': 'MMM dd'} } },
                                        y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } 
                                    },
                                    responsive: true, maintainAspectRatio: false,
                                    plugins: { legend: { display: true } }
                                }
                            });
                        } else {
                            noDeviceDetailActivityDataMsgElem.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        deviceDetailActivityLoadingMsg.style.display = 'none';
                        noDeviceDetailActivityDataMsgElem.textContent = `Error: ${escapeHtml(error.message)}`;
                        noDeviceDetailActivityDataMsgElem.style.display = 'block';
                        console.error('Error fetching detailed device activity:', error);
                    });
            });

            // An√°lisis de Frecuencia Agregada
            analyzeFrequencyButton.addEventListener('click', function() { 
                if (!currentSelectedMacForAnalysis) {
                    alert("Por favor, seleccione un dispositivo de la tabla primero."); return;
                }
                const granularity = granularitySelect.value;
                const startDate = freqStartDateInput.value; const endDate = freqEndDateInput.value;
                
                if ((granularity === 'daily_date') && (!startDate || !endDate)) { // daily_date ya no est√° en este select, pero por si acaso
                    alert("Las fechas de inicio y fin son requeridas para la granularidad por fecha espec√≠fica.");
                    return;
                }
                if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                     alert("La fecha 'Desde' no puede ser posterior a la fecha 'Hasta'."); return;
                }

                let apiUrl = `/api/device-activity/${currentSelectedMacForAnalysis}?granularity=${granularity}`;
                if (startDate) apiUrl += `&startDate=${startDate}`; if (endDate) apiUrl += `&endDate=${endDate}`;

                deviceAggregatedActivityLoadingMsg.style.display = 'block';
                noDeviceAggregatedActivityDataMsgElem.style.display = 'none';
                deviceAggregatedActivityChartContainer.style.display = 'none';
                if (deviceAggregatedActivityChartInstance) deviceAggregatedActivityChartInstance.destroy();

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`) });
                        return response.json();
                    })
                    .then(data => {
                        deviceAggregatedActivityLoadingMsg.style.display = 'none';
                        // Asegurarse que hay datos > 0, excepto para granularidades que siempre deben mostrar todas las etiquetas (hourly, daily_week)
                        const hasMeaningfulData = (granularity === 'hourly' || granularity === 'daily_week') ? 
                                                  (data.labels && data.labels.length > 0) : 
                                                  (data.labels && data.labels.length > 0 && data.data.some(d => d > 0));

                        if (hasMeaningfulData) {
                            deviceAggregatedActivityChartContainer.style.display = 'block';
                            
                            let chartOptions = {
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
                                responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }
                            };
                            // Para granularidades basadas en tiempo que no son 'hourly' o 'daily_week', usar escala de tiempo
                            if (['weekly', 'monthly'].includes(granularity) || (granularity === 'daily_date' && data.labels.every(l => l.match(/^\d{4}-\d{2}-\d{2}$/)))) {
                                chartOptions.scales.x = {type: 'time', time: {tooltipFormat: 'yyyy-MM-dd'}};
                                if (granularity === 'weekly') chartOptions.scales.x.time.unit = 'week';
                                if (granularity === 'monthly') chartOptions.scales.x.time.unit = 'month';
                                if (granularity === 'daily_date') chartOptions.scales.x.time.unit = 'day';
                            }


                            deviceAggregatedActivityChartInstance = new Chart(deviceAggregatedActivityChartCanvas, { 
                                type: 'bar', 
                                data: { 
                                    labels: data.labels, 
                                    datasets: [{ 
                                        label: `Detecciones (${granularity}) para ${escapeHtml(currentSelectedMacForAnalysis)}`, 
                                        data: data.data, 
                                        backgroundColor: 'rgba(75, 192, 192, 0.6)', 
                                        borderColor: 'rgba(75, 192, 192, 1)', 
                                        borderWidth: 1 
                                    }] 
                                },
                                options: chartOptions
                            });
                        } else { 
                            noDeviceAggregatedActivityDataMsgElem.style.display = 'block'; 
                        }
                    })
                    .catch(error => {
                        deviceAggregatedActivityLoadingMsg.style.display = 'none';
                        noDeviceAggregatedActivityDataMsgElem.textContent = `Error: ${escapeHtml(error.message)}`;
                        noDeviceAggregatedActivityDataMsgElem.style.display = 'block'; console.error('Error fetching aggregated device activity:', error);
                    });
            });
            
            // An√°lisis de Horas Pico (Estad√≠sticas Generales)
            function fetchAndRenderPeakActivityStats() {
                const startDate = peakStatsStartDateInput.value;
                const endDate = peakStatsEndDateInput.value;

                if (!startDate || !endDate) {
                    noPeakActivityStatsDataMsgElem.textContent = 'Seleccione un rango de fechas.';
                    noPeakActivityStatsDataMsgElem.style.display = 'block';
                    peakActivityStatsChartContainer.style.display = 'none'; // Corregido: usar peakActivityStatsChartContainer
                    if (peakActivityStatsChartInstance) peakActivityStatsChartInstance.destroy();
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                     alert("La fecha 'Desde' no puede ser posterior a la fecha 'Hasta' para el an√°lisis de horas pico.");
                     return;
                }

                if (peakActivityStatsChartInstance) peakActivityStatsChartInstance.destroy();
                peakActivityStatsChartContainer.style.display = 'none'; // Corregido
                peakActivityStatsLoadingMsg.style.display = 'block';
                noPeakActivityStatsDataMsgElem.style.display = 'none';

                const apiUrl = `/api/peak-activity-hours?startDate=${startDate}&endDate=${endDate}`;

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`) });
                        return response.json();
                    })
                    .then(data => {
                        peakActivityStatsLoadingMsg.style.display = 'none';
                        if (data.labels && data.labels.length > 0 && data.data.some(d => d > 0)) {
                            peakActivityStatsChartContainer.style.display = 'block'; // Corregido
                            peakActivityStatsChartInstance = new Chart(peakActivityStatsChartCanvas, { 
                                type: 'bar',
                                data: {
                                    labels: data.labels,
                                    datasets: [{
                                        label: `Dispositivos √önicos por Hora (${startDate} a ${endDate})`,
                                        data: data.data,
                                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                                        borderColor: 'rgba(255, 159, 64, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
                                    responsive: true, maintainAspectRatio: false,
                                    plugins: { legend: { display: true, labels:{font:{size:10}} } }
                                }
                            });
                        } else {
                             noPeakActivityStatsDataMsgElem.textContent = 'No hay datos para el rango seleccionado.';
                             noPeakActivityStatsDataMsgElem.style.display = 'block';
                             peakActivityStatsChartContainer.style.display = 'none'; // Corregido
                        } 
                    })
                    .catch(error => {
                        peakActivityStatsLoadingMsg.style.display = 'none';
                        noPeakActivityStatsDataMsgElem.textContent = `Error: ${escapeHtml(error.message)}`;
                        noPeakActivityStatsDataMsgElem.style.display = 'block';
                        peakActivityStatsChartContainer.style.display = 'none'; // Corregido
                        console.error('Error fetching peak activity for general stats:', error);
                    });
            }
            analyzePeakStatsButton.addEventListener('click', fetchAndRenderPeakActivityStats);

            // An√°lisis de Fabricantes (Estad√≠sticas Generales)
            function fetchAndRenderManufacturerAnalysis() { 
                if (manufacturerAnalysisChartInstance) manufacturerAnalysisChartInstance.destroy();
                document.getElementById('manufacturerAnalysisChart').style.display = 'none';
                noManufacturerDataMsg.textContent = 'Cargando datos...';
                noManufacturerDataMsg.style.display = 'block';

                fetch('/api/manufacturer-analysis?topN=7') 
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`) });
                        return response.json();
                    })
                    .then(data => {
                        if (data.labels && data.labels.length > 0 && data.data.some(d => d > 0)) {
                            document.getElementById('manufacturerAnalysisChart').style.display = 'block';
                            noManufacturerDataMsg.style.display = 'none';
                            manufacturerAnalysisChartInstance = new Chart(manufacturerAnalysisChartCanvas, {
                                type: 'pie',
                                data: {
                                    labels: data.labels,
                                    datasets: [{
                                        label: 'Dispositivos por Fabricante',
                                        data: data.data,
                                        backgroundColor: [ 
                                            'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)',
                                            'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                                            'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                                            'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)'
                                        ],
                                        hoverOffset: 4
                                    }]
                                },
                                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: {boxWidth:12, font:{size:10}} } } }
                            });
                        } else {
                            noManufacturerDataMsg.textContent = 'No hay datos de fabricantes para mostrar.';
                            document.getElementById('manufacturerAnalysisChart').style.display = 'none';
                        }
                    })
                    .catch(error => {
                        noManufacturerDataMsg.textContent = `Error: ${escapeHtml(error.message)}`;
                        document.getElementById('manufacturerAnalysisChart').style.display = 'none';
                        console.error('Error fetching manufacturer analysis:', error);
                    });
            }

            // --- NUEVAS FUNCIONES PARA AN√ÅLISIS RSSI ---
            function fetchAndPopulateEspSelectorForDeviceRssiTrend(macAddress) {
                espSelectForDeviceRssiTrend.innerHTML = '<option value="">Todos los ESPs</option>'; // Reset
                if (!macAddress) return;

                fetch(`/api/esps-for-mac/${macAddress}`)
                    .then(response => response.json())
                    .then(esps => {
                        if (esps && esps.length > 0) {
                            esps.forEach(espId => {
                                const option = document.createElement('option');
                                option.value = espId;
                                option.textContent = espId;
                                espSelectForDeviceRssiTrend.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error('Error fetching ESPs for MAC:', error));
            }

            function fetchAndPopulateAllKnownEspsSelector() {
                espSelectForEspRssiDistribution.innerHTML = '<option value="">Seleccione un ESP</option>'; // Reset
                fetch('/api/all-known-esps')
                    .then(response => response.json())
                    .then(esps => {
                        if (esps && esps.length > 0) {
                            esps.forEach(espId => {
                                const option = document.createElement('option');
                                option.value = espId;
                                option.textContent = espId;
                                espSelectForEspRssiDistribution.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error('Error fetching all known ESPs:', error));
            }
            // Habilitar bot√≥n de an√°lisis de distribuci√≥n RSSI de ESP cuando se selecciona un ESP
            espSelectForEspRssiDistribution.addEventListener('change', function() {
                analyzeEspRssiDistributionButton.disabled = !this.value;
            });


            analyzeDeviceRssiTrendButton.addEventListener('click', function() {
                if (!currentSelectedMacForAnalysis) {
                    alert("Por favor, seleccione un dispositivo de la tabla primero."); return;
                }
                const startDate = rssiTrendStartDateInput.value;
                const endDate = rssiTrendEndDateInput.value;
                const selectedEspId = espSelectForDeviceRssiTrend.value;

                if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                     alert("La fecha 'Desde' no puede ser posterior a la fecha 'Hasta'."); return;
                }

                let apiUrl = `/api/device-rssi-trend/${currentSelectedMacForAnalysis}?`;
                if (startDate) apiUrl += `startDate=${startDate}&`;
                if (endDate) apiUrl += `endDate=${endDate}&`;
                if (selectedEspId) apiUrl += `esp_id=${selectedEspId}&`;
                apiUrl = apiUrl.slice(0, -1); // Remove last '&' or '?'

                deviceRssiTrendLoadingMsg.style.display = 'block';
                noDeviceRssiTrendDataMsg.style.display = 'none';
                deviceRssiTrendChartContainer.style.display = 'none';
                if (deviceRssiTrendChartInstance) deviceRssiTrendChartInstance.destroy();

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`) });
                        return response.json();
                    })
                    .then(apiData => {
                        deviceRssiTrendLoadingMsg.style.display = 'none';
                        if (apiData.datasets && apiData.datasets.length > 0 && apiData.datasets.some(ds => ds.data.length > 0)) {
                            deviceRssiTrendChartContainer.style.display = 'block';
                            
                            const processedDatasets = apiData.datasets.map((ds, index) => ({
                                ...ds,
                                borderColor: chartColors[index % chartColors.length],
                                backgroundColor: chartColors[index % chartColors.length].replace('1)', '0.2)'), // Para fill
                                tension: 0.1,
                                fill: false // O true si quieres √°rea bajo la curva
                            }));

                            deviceRssiTrendChartInstance = new Chart(deviceRssiTrendChartCanvas, {
                                type: 'line',
                                data: {
                                    datasets: processedDatasets 
                                },
                                options: {
                                    responsive: true, maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            type: 'time',
                                            time: { 
                                                unit: 'minute', // Ajustar seg√∫n la densidad de datos esperada
                                                tooltipFormat: 'yyyy-MM-dd HH:mm:ss',
                                                displayFormats: {
                                                    millisecond: 'HH:mm:ss.SSS',
                                                    second: 'HH:mm:ss',
                                                    minute: 'HH:mm',
                                                    hour: 'HH:00',
                                                }
                                            },
                                            title: { display: true, text: 'Timestamp' }
                                        },
                                        y: {
                                            title: { display: true, text: 'RSSI (dBm)' },
                                            min: apiData.min_rssi, // Usar min/max de la API
                                            max: apiData.max_rssi,
                                            ticks: { stepSize: 5 }
                                        }
                                    },
                                    plugins: { 
                                        legend: { display: true, position: 'top' },
                                        tooltip: { mode: 'index', intersect: false }
                                    }
                                }
                            });
                        } else {
                            noDeviceRssiTrendDataMsg.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        deviceRssiTrendLoadingMsg.style.display = 'none';
                        noDeviceRssiTrendDataMsg.textContent = `Error: ${escapeHtml(error.message)}`;
                        noDeviceRssiTrendDataMsg.style.display = 'block';
                        console.error('Error fetching device RSSI trend:', error);
                    });
            });

            analyzeEspRssiDistributionButton.addEventListener('click', function() {
                const selectedEspId = espSelectForEspRssiDistribution.value;
                if (!selectedEspId) {
                    alert("Por favor, seleccione un ESP ID."); return;
                }
                const startDate = rssiDistStartDateInput.value;
                const endDate = rssiDistEndDateInput.value;

                if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                     alert("La fecha 'Desde' no puede ser posterior a la fecha 'Hasta'."); return;
                }

                let apiUrl = `/api/esp-rssi-distribution/${selectedEspId}?`;
                if (startDate) apiUrl += `startDate=${startDate}&`;
                if (endDate) apiUrl += `endDate=${endDate}&`;
                apiUrl = apiUrl.slice(0, -1);

                espRssiDistributionLoadingMsg.style.display = 'block';
                noEspRssiDistributionDataMsg.style.display = 'none';
                espRssiDistributionChartAdvancedContainer.style.display = 'none';
                if (espRssiDistributionAdvancedChartInstance) espRssiDistributionAdvancedChartInstance.destroy();

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`) });
                        return response.json();
                    })
                    .then(data => {
                        espRssiDistributionLoadingMsg.style.display = 'none';
                        if (data.labels && data.labels.length > 0 && data.data.some(d => d > 0)) {
                            espRssiDistributionChartAdvancedContainer.style.display = 'block';
                            espRssiDistributionAdvancedChartInstance = new Chart(espRssiDistributionChartAdvancedCanvas, {
                                type: 'bar', // O 'pie' si prefieres
                                data: {
                                    labels: data.labels,
                                    datasets: [{
                                        label: `Distribuci√≥n RSSI para ESP ${escapeHtml(selectedEspId)}`,
                                        data: data.data,
                                        backgroundColor: [
                                            'rgba(255, 99, 132, 0.7)','rgba(255, 159, 64, 0.7)',
                                            'rgba(255, 205, 86, 0.7)','rgba(75, 192, 192, 0.7)',
                                            'rgba(54, 162, 235, 0.7)','rgba(153, 102, 255, 0.7)'
                                        ],
                                        borderColor: [
                                            'rgba(255, 99, 132, 1)','rgba(255, 159, 64, 1)',
                                            'rgba(255, 205, 86, 1)','rgba(75, 192, 192, 1)',
                                            'rgba(54, 162, 235, 1)','rgba(153, 102, 255, 1)'
                                        ],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true, maintainAspectRatio: false,
                                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                                    plugins: { legend: { display: true, position: 'top' } }
                                }
                            });
                        } else {
                            noEspRssiDistributionDataMsg.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        espRssiDistributionLoadingMsg.style.display = 'none';
                        noEspRssiDistributionDataMsg.textContent = `Error: ${escapeHtml(error.message)}`;
                        noEspRssiDistributionDataMsg.style.display = 'block';
                        console.error('Error fetching ESP RSSI distribution:', error);
                    });
            });


            // --- INICIALIZACI√ìN ---
            function renderInitialCharts() { 
                // Gr√°fico ESP (sin cambios)
                try {
                    const espChartCanvas = document.getElementById('espDeviceChart');
                    const noEspDataElem = document.getElementById('noEspData');
                    const espChartLabels = {{ esp_chart_labels | tojson }};
                    const espChartData = {{ esp_chart_data | tojson }};

                    if (espChartCanvas && espChartLabels && espChartLabels.length > 0) {
                        new Chart(espChartCanvas.getContext('2d'), {
                            type: 'bar', data: { labels: espChartLabels, datasets: [{ label: 'Dispositivos √önicos Detectados', data: espChartData, backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] },
                            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } }, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                        noEspDataElem.style.display = 'none';
                    } else if (espChartCanvas) {
                        espChartCanvas.style.display = 'none'; noEspDataElem.style.display = 'block';
                    }
                } catch (e) { console.error("Error renderizando ESP chart:", e); document.getElementById('noEspData').style.display = 'block';}

                // Gr√°fico RSSI (sin cambios)
                try {
                    const rssiChartCanvas = document.getElementById('rssiDistributionChart');
                    const noRssiDataElem = document.getElementById('noRssiData');
                    const rssiChartLabels = {{ rssi_chart_labels | tojson }};
                    const rssiChartData = {{ rssi_chart_data | tojson }};

                    if (rssiChartCanvas && rssiChartLabels && rssiChartLabels.length > 0) {
                        new Chart(rssiChartCanvas.getContext('2d'), {
                            type: 'pie', data: { labels: rssiChartLabels, datasets: [{ data: rssiChartData, backgroundColor: ['rgba(255, 99, 132, 0.7)','rgba(255, 159, 64, 0.7)','rgba(255, 205, 86, 0.7)','rgba(75, 192, 192, 0.7)','rgba(54, 162, 235, 0.7)','rgba(153, 102, 255, 0.7)'], hoverOffset: 4 }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 10, font: {size: 10}}}}} 
                        });
                         noRssiDataElem.style.display = 'none';
                    } else if (rssiChartCanvas) {
                        rssiChartCanvas.style.display = 'none'; noRssiDataElem.style.display = 'block';
                    }
                } catch (e) { console.error("Error renderizando RSSI chart:", e); document.getElementById('noRssiData').style.display = 'block';}
                
                if (document.getElementById('generalStatsSection').classList.contains('active')) {
                    setDefaultDatesForPeakStats();
                    fetchAndRenderPeakActivityStats();
                    fetchAndRenderManufacturerAnalysis();
                } else if (document.getElementById('uniqueDevicesSection').classList.contains('active')) {
                    startAutoRefresh(); 
                }
                
                // Poblar selector de ESPs para distribuci√≥n RSSI al cargar
                fetchAndPopulateAllKnownEspsSelector();
                // Establecer fechas por defecto para los nuevos selectores de RSSI
                setDefaultDatesForInputs(rssiTrendStartDateInput, rssiTrendEndDateInput);
                setDefaultDatesForInputs(rssiDistStartDateInput, rssiDistEndDateInput);
            }

            if (autoRefreshEnabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }

            showSection('uniqueDevicesSection'); 
            renderInitialCharts(); 
            fetchAndRenderUniqueDevices(); 
        });
    </script>
</body>
</html>
